class a{position;velocity;size;active=!0;isJumping=!1;health=3;invulnerable=!1;invulnerableTimer=0;constructor(e,i){this.position={x:e,y:i},this.velocity={dx:0,dy:0},this.size={width:32,height:48}}update(e){if(!this.active)return;if(this.position.x+=this.velocity.dx*e,this.position.y+=this.velocity.dy*e,this.invulnerable){if(this.invulnerableTimer-=e,this.invulnerableTimer<=0)this.invulnerable=!1}}render(e){if(!this.active)return;if(this.invulnerable&&Math.floor(Date.now()/100)%2===0)return;e.fillStyle="#FFD700",e.fillRect(this.position.x,this.position.y,this.size.width,this.size.height),e.fillStyle="#FF0000",e.fillRect(this.position.x+10,this.position.y+5,12,12)}getBounds(){return{x:this.position.x,y:this.position.y,width:this.size.width,height:this.size.height}}moveLeft(){this.velocity.dx=-5}moveRight(){this.velocity.dx=5}stop(){this.velocity.dx=0}jump(e){if(!this.isJumping)this.velocity.dy=e,this.isJumping=!0}applyGravity(e){this.velocity.dy+=e}land(){this.isJumping=!1,this.velocity.dy=0}takeDamage(){if(this.invulnerable)return!1;if(this.health--,this.invulnerable=!0,this.invulnerableTimer=2000,this.health<=0)return this.active=!1,!0;return!1}getHealth(){return this.health}heal(){this.health=Math.min(this.health+1,3)}reset(e,i){this.position={x:e,y:i},this.velocity={dx:0,dy:0},this.health=3,this.active=!0,this.isJumping=!1,this.invulnerable=!1,this.invulnerableTimer=0}}class l{position;velocity;size;active=!0;type;health;constructor(e,i,t="roman"){this.position={x:e,y:i},this.type=t;let s={roman:2,centurion:1.5,lion:3},n={roman:{width:24,height:40},centurion:{width:28,height:44},lion:{width:32,height:28}},o={roman:1,centurion:2,lion:1};this.velocity={dx:-s[t],dy:0},this.size=n[t],this.health=o[t]}update(e){if(!this.active)return;if(this.position.x+=this.velocity.dx*e,this.position.y+=this.velocity.dy*e,this.position.x<-this.size.width)this.active=!1}render(e){if(!this.active)return;let i={roman:"#8B4513",centurion:"#CD853F",lion:"#DEB887"};e.fillStyle=i[this.type],e.fillRect(this.position.x,this.position.y,this.size.width,this.size.height),e.fillStyle="#000000",e.fillRect(this.position.x+5,this.position.y+5,6,6),e.fillRect(this.position.x+this.size.width-11,this.position.y+5,6,6)}getBounds(){return{x:this.position.x,y:this.position.y,width:this.size.width,height:this.size.height}}takeDamage(){if(this.health--,this.health<=0)return this.active=!1,!0;return!1}getHealth(){return this.health}reverseDirection(){this.velocity.dx=-this.velocity.dx}}class h{currentScore=0;multiplier=1;events=[];maxEvents=100;constructor(e=0){this.currentScore=e}addPoints(e,i="bonus"){let t=Math.floor(e*this.multiplier);if(this.currentScore+=t,this.events.push({type:i,points:t,timestamp:Date.now()}),this.events.length>this.maxEvents)this.events.shift()}enemyDefeated(e="roman"){let i={roman:100,centurion:250,lion:500};this.addPoints(i[e],"enemy_defeated")}itemCollected(e="coin"){let i={potion:50,helmet:150,shield:200,coin:25};this.addPoints(i[e],"item_collected")}levelComplete(e,i=0){let t=e*1000;this.addPoints(t+i,"level_complete")}setMultiplier(e){this.multiplier=Math.max(1,e)}getMultiplier(){return this.multiplier}resetMultiplier(){this.multiplier=1}getScore(){return this.currentScore}reset(){this.currentScore=0,this.multiplier=1,this.events=[]}getRecentEvents(e=10){return this.events.slice(-e)}serialize(){return JSON.stringify({score:this.currentScore,multiplier:this.multiplier,events:this.events})}static deserialize(e){let i=JSON.parse(e),t=new h(i.score);return t.multiplier=i.multiplier,t.events=i.events,t}}class c{highScores=[];maxEntries=10;storageKey="asterix_high_scores";constructor(e=10){this.maxEntries=e}addScore(e,i,t){let s={score:e,playerName:i,date:new Date().toISOString(),level:t};if(this.highScores.push(s),this.highScores.sort((n,o)=>o.score-n.score),this.highScores.length>this.maxEntries)this.highScores=this.highScores.slice(0,this.maxEntries);return this.highScores.includes(s)}isHighScore(e){if(this.highScores.length<this.maxEntries)return!0;return e>this.highScores[this.highScores.length-1].score}getHighScores(){return[...this.highScores]}getTopScore(){return this.highScores.length>0?this.highScores[0].score:0}clear(){this.highScores=[]}serialize(){return JSON.stringify(this.highScores)}deserialize(e){try{this.highScores=JSON.parse(e)}catch{this.highScores=[]}}saveToLocalStorage(){if(typeof localStorage<"u")localStorage.setItem(this.storageKey,this.serialize())}loadFromLocalStorage(){if(typeof localStorage<"u"){let e=localStorage.getItem(this.storageKey);if(e)this.deserialize(e)}}}var m={canvasWidth:800,canvasHeight:600,playerSpeed:5,enemySpeed:2,gravity:0.5,jumpStrength:-12};class p{ctx;player;enemies=[];score;highScoreManager;config;isRunning=!1;lastTime=0;level=1;enemySpawnTimer=0;groundLevel;keys=new Set;constructor(e,i={}){let t=e.getContext("2d");if(!t)throw Error("Failed to get 2D context");this.ctx=t,this.config={...m,...i},this.groundLevel=this.config.canvasHeight-100,this.player=new a(100,this.groundLevel-48),this.score=new h,this.highScoreManager=new c,this.setupEventListeners()}setupEventListeners(){window.addEventListener("keydown",(e)=>{if(this.keys.add(e.key),e.key===" "||e.key==="ArrowUp"){if(e.preventDefault(),this.player.position.y>=this.groundLevel-this.player.size.height)this.player.jump(this.config.jumpStrength)}}),window.addEventListener("keyup",(e)=>{this.keys.delete(e.key)})}handleInput(){if(this.keys.has("ArrowLeft")||this.keys.has("a"))this.player.moveLeft();else if(this.keys.has("ArrowRight")||this.keys.has("d"))this.player.moveRight();else this.player.stop();if(this.player.position.x<0)this.player.position.x=0;if(this.player.position.x>this.config.canvasWidth-this.player.size.width)this.player.position.x=this.config.canvasWidth-this.player.size.width}spawnEnemy(){let e=["roman","centurion","lion"],i=e[Math.floor(Math.random()*e.length)],t=new l(this.config.canvasWidth,this.groundLevel-40,i);this.enemies.push(t)}checkCollision(e,i){return e.x<i.x+i.width&&e.x+e.width>i.x&&e.y<i.y+i.height&&e.y+e.height>i.y}handleCollisions(){let e=this.player.getBounds();for(let i of this.enemies){if(!i.active)continue;let t=i.getBounds();if(this.checkCollision(e,t)){if(this.player.takeDamage())this.gameOver();i.active=!1}}}update(e){if(!this.isRunning)return;let i=e/16.67;if(this.handleInput(),this.player.applyGravity(this.config.gravity),this.player.update(i),this.player.position.y>=this.groundLevel-this.player.size.height)this.player.position.y=this.groundLevel-this.player.size.height,this.player.land();if(this.enemySpawnTimer+=e,this.enemySpawnTimer>2000)this.spawnEnemy(),this.enemySpawnTimer=0;for(let t of this.enemies)t.update(i);this.enemies=this.enemies.filter((t)=>t.active),this.handleCollisions(),this.score.addPoints(1,"bonus")}render(){this.ctx.fillStyle="#87CEEB",this.ctx.fillRect(0,0,this.config.canvasWidth,this.config.canvasHeight),this.ctx.fillStyle="#8B4513",this.ctx.fillRect(0,this.groundLevel,this.config.canvasWidth,this.config.canvasHeight-this.groundLevel),this.player.render(this.ctx);for(let e of this.enemies)e.render(this.ctx);this.renderUI()}renderUI(){if(this.ctx.fillStyle="#000000",this.ctx.font="bold 24px monospace",this.ctx.fillText(`Score: ${this.score.getScore()}`,10,30),this.ctx.fillText(`Health: ${this.player.getHealth()}`,10,60),this.ctx.fillText(`Level: ${this.level}`,10,90),this.score.getMultiplier()>1)this.ctx.fillStyle="#FFD700",this.ctx.fillText(`x${this.score.getMultiplier()}`,10,120)}gameLoop=(e)=>{let i=e-this.lastTime;if(this.lastTime=e,this.update(i),this.render(),this.isRunning)requestAnimationFrame(this.gameLoop)};start(){if(this.isRunning)return;this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(this.gameLoop)}pause(){this.isRunning=!1}resume(){if(this.isRunning)return;this.isRunning=!0,this.lastTime=performance.now(),requestAnimationFrame(this.gameLoop)}reset(){this.player.reset(100,this.groundLevel-48),this.enemies=[],this.score.reset(),this.level=1,this.enemySpawnTimer=0,this.keys.clear()}async gameOver(){this.pause();let e=this.score.getScore(),i=prompt("Game Over! Enter your name:")||"Anonymous";if(this.highScoreManager.isHighScore(e)){this.highScoreManager.addScore(e,i,this.level);try{let n=await(await fetch("/api/scores",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({score:e,playerName:i,level:this.level})})).json();if(n.isHighScore)alert(`New High Score! Rank #${n.rank}`)}catch{console.error("Failed to submit score to server")}}if(confirm("Play again?"))this.reset(),this.start()}getScore(){return this.score}getHighScoreManager(){return this.highScoreManager}defeatEnemy(e){if(e.takeDamage())this.score.enemyDefeated(e.type)}}var r;async function u(){let e=document.getElementById("scoresContainer");if(!e)return;try{let t=await(await fetch("/api/scores")).json();if(t.success&&t.scores.length>0){let s=document.createElement("ul");s.className="score-list",t.scores.forEach((n,o)=>{let d=document.createElement("li");d.innerHTML=`
          <span class="score-rank">#${o+1}</span>
          <span class="score-name">${n.playerName}</span>
          <span class="score-value">${n.score.toLocaleString()}</span>
        `,s.appendChild(d)}),e.innerHTML="",e.appendChild(s)}else e.innerHTML='<p class="loading">No high scores yet. Be the first!</p>'}catch(i){e.innerHTML='<p class="loading">Failed to load high scores</p>'}}function y(){let e=document.getElementById("gameCanvas");if(!e){console.error("Canvas not found");return}r=new p(e);let i=document.getElementById("startBtn"),t=document.getElementById("pauseBtn"),s=document.getElementById("resetBtn"),n=document.getElementById("refreshScoresBtn");i?.addEventListener("click",()=>{r.start()}),t?.addEventListener("click",()=>{r.pause()}),s?.addEventListener("click",()=>{r.reset(),r.start()}),n?.addEventListener("click",()=>{u()}),u()}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",y);else y();
